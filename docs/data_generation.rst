.. Copyright 2020 University of Maryland and other Hatchet Project Developers.
See the top-level LICENSE file for details.

   SPDX-License-Identifier: MIT

*****************************
Generating Profiling Datasets
*****************************

HPCToolkit
==========
Hatchet can read HPCToolkit database generated by using ``hpcprof-mpi`` command.

HPCToolkit can be installed with Spack, ``spack install hpctoolkit``, or manually. 
Build instructions can be found at http://hpctoolkit.org/software-instructions.html

.. code-block:: console

   >>> hpcstruct ./<program>
   >>> mpirun -np <num_ranks> hpcrun <hpcrun_args> ./<program> <program_args>
   >>> mpirun -np <num_ranks> hpcprof-mpi --metric-db=yes -S <hpcstruct_file> -I <path_to_src> <measurements-directory>

Please note that you should use ``--metric-db`` option.

More information information about HPCToolkit can be found at 
http://hpctoolkit.org/documentation.html

Caliper
=======
Caliper can be installed with Spack or directly from the repository 
https://github.com/LLNL/Caliper. 

If you want to install Caliper using Spack, first, you should run ``spack edit caliper`` 
command and add the following arguments to the cmake_args() function:
``'-DWITH_SYMBOLLOOKUP=On',
'-DWITH_LIBDW=On',
'-DWITH_LIBUNWIND=On',
'-DWITH_SAMPLER=On'``.
Then, you should install Caliper master version.

You can either use your own .config files (default: caliper.config) to get profile data or
you can use Caliper's built-in profiling configurations ``hatchet-region-profile`` 
and ``hatchet-sample-profile``.

If you use your own .config file, you can set it to CALI_CONFIG_FILE environment 
variable and then, you can run your program. In addition, you should include cali.h file
and call cali_init() function at the beginning of your program. Example configurations can be found at 
https://github.com/LLNL/Caliper/tree/master/examples/configs

If you use built-in configurations, you should set it to CALI_CONFIG environment variable 
(e.g. ``#CALI_CONFIG=hatchet-region-profile``).

Note that you should link libcaliper to your target program. More information about
how to use Caliper can be found at https://software.llnl.gov/Caliper/index.html

Callgrind
=========


cProfile
========


Pyinstrument
============
Hatchet can read Pyinstrument JSON files which can be generated 
by using its Python API or using the command line.

**Command line**

.. code-block:: console

   >>> pyinstrument -r json -o <outputfile>.json ./<program>


**Python API**

.. code-block:: python

   from pyinstrument import Profiler
   from pyinstrument.renderers import JSONRenderer
   profiler = Profiler()

   profiler.start()
   # do some work
   profiler.stop()

   print(JSONRenderer().render(profiler.last_session))

More information information about Pyinstrument can be found at 
https://github.com/joerick/pyinstrument